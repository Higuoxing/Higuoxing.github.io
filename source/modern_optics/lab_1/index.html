<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Lab for modern optics</title>
    <meta name="description" content="The HTML5 Herald">
    <meta name="author" content="SitePoint">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/Buttons/2.0.0/css/buttons.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Buttons/2.0.0/js/buttons.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="text/javascript" src="/modern_optics/lab_1/lib/cie_rgb_converter.js"></script>
    <link rel="stylesheet" href="/modern_optics/lab_1/css/index.css">
</head>
<body>
<div>
    <h1>Labs for Modern Optics</h1>
    <div id="2D-plot">
        <div id="img_show_box" style="float: left">
            <canvas id="img_display" width="300" height="300" ></canvas>
        </div>
        <div id="cie_diagram_box" style="">
            <canvas id="CIE_XY" width="300" height="300"></canvas>
        </div>
    </div>
    <div id="3D-plot" style="float: left">
        <div id="mygraph" width="300" height="300"></div>
    </div>

    <div id="upload_file_box">
        <input type="file" id="img-input" style="display: none" />
        <label id="upload_btn" style="height: auto; width: 300px" for="img-input" class="button button-large button-caution button-jumbo">Select Image</label>
    </div>

    <div id="select-area-btn">
        <input type="button" id="area-select" style="display: none">
        <label id="select_btn" style="height: auto; width: 300px" for="area-select" class="button button-large button-caution button-jumbo">Select Area</label>
    </div>
    <p>Author: #06015004<a href="https://higuoxing.com">@Higuoxing</a></p>
    <p>Southeast University</p>
</div>
</body>

<script type="text/javascript">
  // lab for modern optics course

  // load canvas
  var img_canvas = document.getElementById('img_display');
  var img_ctx = img_canvas.getContext('2d');

  // img buffer canvas
  var img_buffer_canvas = document.createElement('canvas');
  var img_buffer_ctx = img_buffer_canvas.getContext('2d');
  img_buffer_canvas.height = 300;
  img_buffer_canvas.width  = 300;

  img_canvas.onmousedown = onArrowClick;
  img_canvas.onmouseup   = stopDragging;
  img_canvas.onmouseout  = stopDragging;
  img_canvas.onmousemove = dragArrow;

  var cie_canvas = document.getElementById('CIE_XY');
  var cie_ctx = cie_canvas.getContext('2d');

  // init
  init();

  // state variable to judge if the image has been uploaded
  var state = '';

  // buttons
  var sel_label     = document.getElementById("select_btn");
  var img_inputElem = document.getElementById("img-input");
  var sel_inputElem = document.getElementById("area-select");

  // arrows
  var arrow_lu   = new Arrow(15 ,  15);
  var arrow_rb   = new Arrow(285, 285);

  var rec_lu_arrow_svg = "/modern_optics/image/arrow-lu.svg";
  var rec_rb_arrow_svg = "/modern_optics/image/arrow-rb.svg";

  var selectedArrow = null;
  var isDragging = false;

  // Listeners
  img_inputElem.addEventListener("change", onImageLoad, false);
  sel_inputElem.addEventListener("click", onSelectArea, false);

  // init page
  function init() {
    // img_ctx.clearRect(0, 0, img_canvas.width, img_canvas.height);
    cie_ctx.clearRect(0, 0, cie_canvas.width, cie_canvas.height);
    var cie_diagram = new Image();
    cie_diagram.src = "/modern_optics/image/chromaticity_stub.svg"
    cie_diagram.onload = function() {
      cie_ctx.drawImage(cie_diagram, 0, 0);
    }
  }

  // on image load
  function onImageLoad () {
    init();
    // on upload image
    fileList = this.files;
    var input_img = fileList[0];

    // clear input value
    img_inputElem.value = '';
    if (!/\/(?:jpeg|jpg|png)/i.test(input_img.type)) {
      alert('请不要选择其他文件~ 喵~');
      return;
    }
    state = 'hasUploaded';

    // display image
    var img = new Image();
    img.src = window.URL.createObjectURL(input_img);
    img.onload = function () {
      // clear image
      img_ctx.clearRect(0, 0, img_canvas.width, img_canvas.height);
      // calculate scaling factor
      var hRatio = img_canvas.width / img.width    ;
      var vRatio = img_canvas.height / img.height  ;
      var ratio  = Math.min ( hRatio, vRatio );
      // draw image
      img_ctx.drawImage(img, 0,0, img.width      , img.height,
        0,0, img.width*ratio, img.height*ratio);
      img_buffer_ctx.drawImage(img_canvas, 0, 0, img_canvas.width, img_canvas.height);
      // plot on cie_diagram
      plotCIEDiagram(img_buffer_canvas);
    }
  }

  // draw diagram
  function plotCIEDiagram (img) {
    sel_label.innerHTML = 'Processing...';

    init();
    var data3D = null;
    var x_ax    = [];
    var y_ax    = [];
    var z_ax    = [];
    var color3D = [];
    for (var i = arrow_lu.x; i < arrow_rb.x; i += 5) {
      for (var j = arrow_lu.y; j < arrow_rb.y; j += 5) {
        var img_data = img_buffer_ctx.getImageData(i, j, 3, 3);
        var color = img_data.data;
        var cie_x_y = rgb_to_cie(color[0], color[1], color[2]);
        x = cie_x_y[0]; y = cie_x_y[1];
        cie_ctx.putImageData(img_data, 285 * x + 40.7185, (-291.667) * y + 260);
        var R = color[0];
        var G = color[1];
        var B = color[2];
        // x_ax.push(R/(R+G+B));
        // y_ax.push(G/(R+G+B));
        // z_ax.push(B/(R+G+B));
        x_ax.push(x);
        y_ax.push(y);
        z_ax.push(1-x-y);
        color3D.push('rgb('+color[0] + ',' + color[1] + ',' + color[2] + ')');
      }
    }
    data3D = {
      x: x_ax,
      y: y_ax,
      z: z_ax,
      type: 'scatter3d',
      marker: { color: color3D },
      mode: 'markers'
    };
    console.log(color3D);
    draw3Dgraph(data3D);
    sel_label.innerHTML = 'Select Area';
  }

  // state controller
  function onSelectArea() {
    if (state == 'hasUploaded') {
      initSelectArea();
      state = 'Choosing';
    } else if (state == 'Choosing') {
      sel_label.innerHTML = 'Processing...'
      plotCIEDiagram(img_buffer_canvas);
      sel_label.innerHTML = 'Select Area';
    } else {
      alert('请选择一张图片喵~');
    }
  }

  // Select arrow
  function Arrow(x, y) {
    this.x          = x;
    this.y          = y;
    this.radius     = 15;
    this.isSelected = false;
  }

  // initial selected area
  function initSelectArea() {
    // initial two arrows
    // draw arrow
    var rec_lu_arrow = new Image();
    var rec_rb_arrow = new Image();

    rec_lu_arrow.src = rec_lu_arrow_svg;
    rec_rb_arrow.src = rec_rb_arrow_svg;

    rec_lu_arrow.radius = 30;
    rec_rb_arrow.radius = 30;

    rec_lu_arrow.onload = function () {
      img_ctx.drawImage(rec_lu_arrow, arrow_lu.x - 15, arrow_lu.y - 15, rec_lu_arrow.radius, rec_lu_arrow.radius);
    };

    rec_rb_arrow.onload = function () {
      // draw arrow
      img_ctx.drawImage(rec_rb_arrow, arrow_rb.x - rec_rb_arrow.radius + 15,
        arrow_rb.y - rec_rb_arrow.radius + 15, rec_rb_arrow.radius, rec_rb_arrow.radius);
      // do nothing;
    };
  }

  // onClick
  function onArrowClick(e) {
    var clickX = e.pageX - img_canvas.offsetLeft;
    var clickY = e.pageY - img_canvas.offsetTop;

    // high order function to calculate distance
    function distanceFromCenter(arrow) {
      return Math.sqrt(Math.pow(arrow.x - clickX, 2) + Math.pow(arrow.y - clickY, 2));
    }

    // hard code, not so well
    if (distanceFromCenter(arrow_lu) <= arrow_lu.radius) {
      arrow_rb.isSelected = false;
      arrow_lu.isSelected = true;
      isDragging = true;
      selectedArrow = arrow_lu;
    } else if (distanceFromCenter(arrow_rb) <= arrow_rb.radius) {
      arrow_lu.isSelected = false;
      arrow_rb.isSelected = true;
      isDragging = true;
      selectedArrow = arrow_rb;
    } else {
      arrow_rb.isSelected = false;
      arrow_lu.isSelected = false;
      isDragging = false;
      selectedArrow = null;
      // do nothing
    }
  }

  // mouse up isDragging = false
  function stopDragging() {
    isDragging = false;
  }

  // drag arrows
  function dragArrow(e) {
    if (isDragging == true) {
      if (selectedArrow != null) {
        var x = e.pageX - img_canvas.offsetLeft;
        var y = e.pageY - img_canvas.offsetTop;

        selectedArrow.x = x;
        selectedArrow.y = y;
        // update canvas
        updateSelectArea();
        // return;
      }
    }
  }

  // update SelectArea
  function updateSelectArea() {
    // cache canvas
    if (!this.cacheCanvas) {
      this.cacheCanvas = document.createElement('canvas');
      this.cacheCanvas.width = img_canvas.width;
      this.cacheCanvas.height = img_canvas.height;
    }

    var cache_ctx = this.cacheCanvas.getContext('2d');
    //cache_ctx.drawImage(img_buffer_canvas, 0, 0, img_buffer_canvas.width, img_buffer_canvas.height);

    // new images
    var rec_lu_arrow = new Image();
    var rec_rb_arrow = new Image();

    rec_lu_arrow.src = rec_lu_arrow_svg;
    rec_rb_arrow.src = rec_rb_arrow_svg;

    rec_lu_arrow.radius = 30;
    rec_rb_arrow.radius = 30;

    rec_lu_arrow.onload = function () {
      cache_ctx.drawImage(img_buffer_canvas, 0, 0, img_buffer_canvas.width, img_buffer_canvas.height);
      cache_ctx.drawImage(rec_lu_arrow, arrow_lu.x - 15,
        arrow_lu.y - 15, rec_lu_arrow.radius, rec_lu_arrow.radius);
    };

    rec_rb_arrow.onload = function () {
      // draw arrow
      cache_ctx.drawImage(rec_rb_arrow, arrow_rb.x - rec_rb_arrow.radius + 15,
        arrow_rb.y - rec_rb_arrow.radius + 15, rec_rb_arrow.radius, rec_rb_arrow.radius);
      // do nothing;
    };

    // selected rectangle area
    // fix me: hard code
    cache_ctx.beginPath();
    cache_ctx.moveTo(arrow_lu.x, arrow_lu.y);
    cache_ctx.lineTo(arrow_rb.x, arrow_lu.y);
    cache_ctx.lineTo(arrow_rb.x, arrow_rb.y);
    cache_ctx.lineTo(arrow_lu.x, arrow_rb.y);
    cache_ctx.lineTo(arrow_lu.x, arrow_rb.y);
    cache_ctx.closePath();
    cache_ctx.stroke();


    img_ctx.clearRect(0, 0, img_canvas.width, img_canvas.height);
    img_ctx.drawImage(this.cacheCanvas, 0, 0, this.cacheCanvas.width, this.cacheCanvas.height);
    // clear cache
    cache_ctx.clearRect(0, 0, this.cacheCanvas.width, this.cacheCanvas.height);
  }

  function draw3Dgraph(data3D) {
    var layout = {
      margin: {
        l: 0,
        r: 0,
        b: 0,
        t: 0
      },
      width:  300,
      height: 300
    };
    Plotly.newPlot('mygraph', [data3D], layout);
  }

  // // initial data..
  // z1 = [
  //   [8.83,8.89,8.81,8.87,8.9,8.87],
  //   [8.89,8.94,8.85,8.94,8.96,8.92],
  //   [8.84,8.9,8.82,8.92,8.93,8.91],
  //   [8.79,8.85,8.79,8.9,8.94,8.92],
  //   [8.79,8.88,8.81,8.9,8.95,8.92],
  //   [8.8,8.82,8.78,8.91,8.94,8.92],
  //   [8.75,8.78,8.77,8.91,8.95,8.92],
  //   [8.8,8.8,8.77,8.91,8.95,8.94],
  //   [8.74,8.81,8.76,8.93,8.98,8.99],
  //   [8.89,8.99,8.92,9.1,9.13,9.11],
  //   [8.97,8.97,8.91,9.09,9.11,9.11],
  //   [9.04,9.08,9.05,9.25,9.28,9.27],
  //   [9,9.01,9,9.2,9.23,9.2],
  //   [8.99,8.99,8.98,9.18,9.2,9.19],
  //   [8.93,8.97,8.97,9.18,9.2,9.18]
  // ];
  // // generating data for other traces..
  // z2 = [];
  // for (var i=0;i<z1.length;i++ ) {
  //   z2_row = [];
  //   for(var j=0;j<z1[i].length;j++) {
  //     z2_row.push(z1[i][j]+1);
  //   }
  //   z2.push(z2_row);
  // }
  //
  // z3 = []
  // for (var i=0;i<z1.length;i++ ) {
  //   z3_row = [];
  //   for(var j=0;j<z1[i].length;j++) {
  //     z3_row.push(z1[i][j]-1);
  //   }
  //   z3.push(z3_row);
  // }
  //
  // // creating data objects..
  // var data_z1 = {z: z1, type: 'surface'};
  // var data_z2 = {z: z2, showscale: false, opacity:0.9, type: 'surface'};
  // var data_z3 = {z: z3, showscale: false, opacity:0.9, type: 'surface'};
  //
  // // Plotting the surfaces..
  // Plotly.newPlot('mygraph', [data_z1, data_z2, data_z3]);

</script>
</html>

<!--39.71875 258-->
<!--298.71875 258-->
<!--298.71875 1-->
<!--39.71875 1-->
<!--39.71875 29-->
<!--268.71875 259-->
