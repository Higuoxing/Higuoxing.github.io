---
title: 换系统啦
date: 2017-11-03 01:28:17
tags:
---

换成了大名鼎鼎的archlinux
换了清华的软件源超级快。不知道是不是喜新厌旧的锅，就是觉得舒服（其实另外一台还在跑ubuntu，贴一张桌面嘿嘿。

![arch_now](./arch_new.png)
<!--more-->

###安装过程
> 记录一下安装过程，以防之后滚挂自己又不能完全修复，只能从头开始

我的是MacBook Air2016，但是安装过程都大同小异
由于我之前利用`BootCamp`安装过一次Windows所以就直接省去了分区这一步
直接将系统盘插入，按着`option`建选择Arch的引导盘
按照官方[Wiki](https://wiki.archlinux.org/index.php/Installation_guide)的说法，这里需要将我们的系统盘进行分区，这里推荐使用`cgdisk`来进行操作

> 分区结果是 (我的air是256G版，linux大约分了80G)

```bash
Device         Start       End   Sectors   Size Type
/dev/sda1         40    409639    409600   200M EFI System
/dev/sda2     409640 315568311 315158672 150.3G Apple Core storage
/dev/sda3  315568312 316837847   1269536 619.9M Apple boot
/dev/sda4  316837848 318672855   1835008   896M Apple HFS/HFS+
/dev/sda5  318935000 321032151   2097152     1G Linux filesystem
/dev/sda6  321032152 488804311 167772160    80G Linux filesystem
/dev/sda7  488965176 490234711   1269536 619.9M Apple boot
```

`/dev/sda5`是我的`/boot`文件夹
`/dev/sda4`用作了`Bootloader`
`/dev/sda6`直接做了根目录，而不像`Ubuntu`一样是把`/home`挂到根目录下

> 格式化我们的分区，做成合适的文件系统

```bash
mkfs.ext4 /dev/sda5
mkfs.ext4 /dev/sda6
mkdir /mnt/boot && mount /dev/sda5 /mnt/boot
```

这里我直接把swap分区放到了根目录下
```bash
dd if=/dev/zero of=/mnt/swapfile bs=1M count=8000000 # 8GB swap partition
chmod 600 /mnt/swapfile
mkswap /mnt/swapfile
```
前两天社团的阿里云学生机总是内存不够，然后三番五次的加swap分区，本来不太用的，结果比`ls`都顺手，嘻嘻

> 这里我们就可以开始安装系统了

值得一提的是，因为MacBook的驱动不太友好？导致我的`wifi-menu`是没办法用的，所以就用了一个不是办法的办法，用USB来用手机的流量，将手机连接电脑后把USB共享网络的开关打开，然后输入`ip link`看一下连接的网络设备的名称，我的当时是`enp0s20u1`
```bash
ip link
# 
# 1: lo: ......
# 2: wlp3s0: ......
# 3: enp0s20u1 ...没错就是它
dhcpcd enp0s20u1
```
然后就可以愉快的上网了！

```bash
pacstrap /mnt base base-devel
genfstab -U -p /mnt >> /mnt/etc/fstab
```
将文件系统写到这个`fstab`表中
之后手动编辑一下这个表，改成这样的
```
#
# /etc/fstab: static file system information
#
# <file system>	<dir>	<type>	<options>	<dump>	<pass>
# /dev/sda7
UUID=4ebc9502-bd2a-4788-8323-f666cfdf0c36	/         	ext4      	rw,relatime,data=ordered	0 1

# /dev/sda6
UUID=d0d2c67a-a169-4100-8ffb-e463285fb0e0	/boot     	ext4      	rw,relatime,data=ordered	0 2

/swapfile none swap defaults 0 0
```

然后就可以进系统啦！
```bash
arch-chroot /mnt /bin/bash
passwd
echo myhostname > /etc/hostname
ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
hwclock --systohc --utc
useradd -m -g users -G wheel -s /bin/bash myusername
passwd myusername
pacman -S sudo
echo "%wheel ALL=(ALL) ALL" > /etc/sudoers.d/10-grant-wheel-group
```

然后设置一下本地信息，编辑`/etc/locale.gen`，这里，我把带zh_CN的都取消了注释
```bash
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf
export LANG=en_US.UTF-8
```

修改一下`/etc/mkinitcpio.conf`把keyboard改为自动监测的
```
HOOKS=(base udev autodetect modconf block filesystems keyboard fsck)
```
然后输入
```bash
mkinitcpio -p linux
```

之后就是设置`Bootloader`了，我们之后引导Arch还需要苹果的`Bootloader`
```bash
pacman -S grub-efi-x86_64
```

编辑`/etc/default/grub`，找到对应的地方修改为
```
GRUB_CMDLINE_LINUX_DEFAULT="quiet rootflags=data=writeback libata.force=1:noncq"
GRUB_DISABLE_SUBMENU=y
```

之后继续输入
```bash
grub-mkconfig -o boot/grub/grub.cfg
grub-mkstandalone -o boot.efi -d usr/lib/grub/x86_64-efi -O x86_64-efi --compress=xz boot/grub/grub.cfg
```
这里的`boot.efi`对我们来说很重要，放到一个地方比如U盘，我们一会会用到，我是直接上传到了github然后在OS X那边clone下来的，~~我太懒了~~

之后就可以退出重启了，记着这次重启到OS X中

重启之后，把我们的`/dev/sda7`重新格式化为`Mac journaled filesystem`

然后就可以设置一个自动运行脚本，为的是让苹果的`Bootloader`看到我们的Arch

```bash
cd /Volumes/disk0s4
mkdir System mach_kernel
cd System
mkdir Library
cd Library
mkdir CoreServices
cd CoreServices
touch SystemVersion.plist
```

编辑`SystemVersion.plist`

```
<xml version="1.0" encoding="utf-8"?>
<plist version="1.0">
<dict>
    <key>ProductBuildVersion</key>
    <string></string>
    <key>ProductName</key>
    <string>Linux</string>
    <key>ProductVersion</key>
    <string>Arch Linux</string>
</dict>
</plist>
```

把之前的`boot.efi`拿来，和`SystemVersion.plist`放到一起

文件结构：
```
|___mach_kernel
|___System
       |
       |___Library
              |
              |___CoreServices
                      |
                      |___SystemVersion.plist
                      |___boot.efi
```

```bash
sudo bless --device /dev/disk0s4 --setBoot
```

对了，苹果为了保护系统，有个类似锁的东西，要在恢复模式下取消`csrutil disable`具体百度就会有解答

好了，可以愉快的进行工作了

> 最小系统的安装大约就是这样了，主要参考了这篇文章，但也有很多都是自己踩坑琢磨的
[arch on air](https://github.com/pandeiro/arch-on-air)

下面是一些后续配置，解决这些之前，先解决我的`wifi`问题...

比较简单的方法，我直接用了`broadcom-wl-dkms`并且安装了...驱动都是没问题的，(`sudo pacman -S linux-macbook`)，键盘背光、屏幕亮度、触摸板什么的都是没问题的...基本后面的就可以自由发挥了，别忘了装中文字体就行，对于这台配置不算高的air来说，`lightdm`足够了，桌面环境用了`cinnamon`，其他的就是看工作/学习需要了，嘻嘻
